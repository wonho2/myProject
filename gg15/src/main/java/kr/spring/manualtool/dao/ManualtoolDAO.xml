<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.spring.manualtool.dao.ManualtoolDAO">

<!-- 총 게시글 수-->
	<select id="selectManualtoolCount" resultType="integer">
		SELECT
		   COUNT(*)
		FROM manualtool mt
		JOIN member_detail m
		ON mt.mem_num = m.mem_num
		<where>
			<if test="keyword != '' and keyfield == 'man_title'">
				mt.man_title LIKE '%' || #{keyword} || '%'
			</if>
			<if test="keyword != '' and keyfield == 'man_content'">
				mt.man_content LIKE '%' || #{keyword} || '%'
			</if>
			<if test="keyword != '' and keyfield == 'mem_nick'">
				m.mem_nick = #{keyword}
			</if>
			<if test="keyuser != ''">
				mt.man_champion = #{keyuser}
			</if>
		</where>
	</select>

<!-- 글 목록 -->
	<select id="selectList" parameterType="map" resultType="manualtoolVO">
		SELECT
		   *
		FROM (SELECT 
		        a.*,
		        rownum rnum
		      FROM(SELECT
		      		  mt.man_num,
		              mt.man_champion,
		              mt.man_season,
		              <![CDATA[
		              REPLACE(REPLACE(mt.man_title, '<', '&lt;'), '>', '&gt;') man_title,
		              ]]>
		              m.mem_nick,
		              mt.man_update,
		              mt.man_hit,
		              mt.man_filename,
		              f.man_fav,
		              r.man_comment
		           FROM manualtool mt
		           LEFT OUTER JOIN (SELECT man_num, COUNT(*) man_fav FROM manualtool_fav GROUP BY man_num) f
		           ON mt.man_num = f.man_num
		           LEFT OUTER JOIN (SELECT man_num, COUNT(*) man_comment FROM manualtool_reply GROUP BY man_num) r
		           ON mt.man_num = r.man_num
		           JOIN member_detail m
		           ON mt.mem_num = m.mem_num
		           <where>
						<if test="keyword != '' and keyfield == 'man_title'">
							mt.man_title LIKE '%' || #{keyword} || '%'
						</if>
						<if test="keyword != '' and keyfield == 'man_content'">
							mt.man_content LIKE '%' || #{keyword} || '%'
						</if>
						<if test="keyword != '' and keyfield == 'mem_nick'">
							m.mem_nick = #{keyword}
						</if>
						<if test="keyuser != ''">
							mt.man_champion = #{keyuser}
						</if>
					</where>
		           ORDER BY mt.man_num DESC)a)
    	<![CDATA[
    	WHERE rnum >= #{start} AND rnum <= #{end}
    	]]>
	</select>
	 
	
<!-- 게시물 상세 페이지 -->
	<!-- <select id="selectBoard" parameterType="Integer" resultType="manualtoolVO">
		SELECT 
			mt.*,
			m.mem_nick  
			FROM manualtool mt JOIN member_detail m ON mt.mem_num = m.mem_num 
			WHERE man_num = #{boardNum}
	</select> -->
	
	
<!-- 글 수정 -->
	<update id="updateManualtool" parameterType="manualtoolVO">
		UPDATE manualtool SET	
			<if test="man_filename != ''">
				man_uploadfile = #{man_uploadfile},
				man_filename = #{man_filename},
			</if>
			man_title = #{man_title},
			man_content = #{man_content} ,
			man_champion = #{man_champion},
			man_season = #{man_season}
			WHERE man_num = #{man_num}
	</update>
	
<!-- =====댓글===== -->	
	<select id="selectListReply" parameterType="map" resultType="manualtoolCommentVO">
 		SELECT
 		   *
 		FROM (SELECT 
 		        m.*, 
 		        rownum rnum 
 		      FROM (SELECT 
                      *
                    FROM (SELECT 
                            mar_num,
 		                    mar_content,
 		                    TO_CHAR(mar_date,'YYYY-MM-DD HH24:MI:SS') mar_date,
 		                    man_num,
 		                    mem_num
                          FROM manualtool_reply where man_num=#{man_num}) r
                               JOIN member_detail m
                               USING(mem_num)
                               ORDER BY r.mar_num DESC)m)
                              
 		<![CDATA[
 		WHERE rnum >= #{start} AND rnum <= #{end}
 		]]>                                 
 	</select>
</mapper>